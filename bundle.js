function X2JS(e){"use strict";function t(){void 0===e.escapeMode&&(e.escapeMode=!0),e.attributePrefix=e.attributePrefix||"_",e.arrayAccessForm=e.arrayAccessForm||"none",e.emptyNodeForm=e.emptyNodeForm||"text",void 0===e.enableToStringFunc&&(e.enableToStringFunc=!0),e.arrayAccessFormPaths=e.arrayAccessFormPaths||[],void 0===e.skipEmptyTextNodesForObj&&(e.skipEmptyTextNodesForObj=!0),void 0===e.stripWhitespaces&&(e.stripWhitespaces=!0),e.datetimeAccessFormPaths=e.datetimeAccessFormPaths||[]}function r(){function e(e){var t=String(e);return 1===t.length&&(t="0"+t),t}"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|^\n+|(\s|\n)+$/g,"")}),"function"!=typeof Date.prototype.toISOString&&(Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"})}function i(e){var t=e.localName;return null==t&&(t=e.baseName),(null==t||""==t)&&(t=e.nodeName),t}function o(e){return e.prefix}function n(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):e}function s(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")}function a(t,r,i){switch(e.arrayAccessForm){case"property":t[r+"_asArray"]=t[r]instanceof Array?t[r]:[t[r]]}if(!(t[r]instanceof Array)&&e.arrayAccessFormPaths.length>0){for(var o=0;o<e.arrayAccessFormPaths.length;o++){var n=e.arrayAccessFormPaths[o];if("string"==typeof n){if(n==i)break}else if(n instanceof RegExp){if(n.test(i))break}else if("function"==typeof n&&n(t,r,i))break}o!=e.arrayAccessFormPaths.length&&(t[r]=[t[r]])}}function l(e){var t=e.split(/[-T:+Z]/g),r=new Date(t[0],t[1]-1,t[2]),i=t[5].split(".");if(r.setHours(t[3],t[4],i[0]),i.length>1&&r.setMilliseconds(i[1]),t[6]&&t[7]){var o=60*t[6]+Number(t[7]),n=/\d\d-\d\d:\d\d$/.test(e)?"-":"+";o=0+("-"==n?-1*o:o),r.setMinutes(r.getMinutes()-o-r.getTimezoneOffset())}else-1!==e.indexOf("Z",e.length-1)&&(r=new Date(Date.UTC(r.getFullYear(),r.getMonth(),r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds(),r.getMilliseconds())));return r}function c(t,r,i){if(e.datetimeAccessFormPaths.length>0){for(var o=i.split(".#")[0],n=0;n<e.datetimeAccessFormPaths.length;n++){var s=e.datetimeAccessFormPaths[n];if("string"==typeof s){if(s==o)break}else if(s instanceof RegExp){if(s.test(o))break}else if("function"==typeof s&&s(obj,r,o))break}return n!=e.datetimeAccessFormPaths.length?l(t):t}return t}function u(t,r){if(t.nodeType==T.DOCUMENT_NODE){for(var n=new Object,l=t.childNodes,h=0;h<l.length;h++){var p=l.item(h);if(p.nodeType==T.ELEMENT_NODE){var d=i(p);n[d]=u(p,d)}}return n}if(t.nodeType==T.ELEMENT_NODE){var n=new Object;n.__cnt=0;for(var l=t.childNodes,h=0;h<l.length;h++){var p=l.item(h),d=i(p);p.nodeType!=T.COMMENT_NODE&&(n.__cnt++,null==n[d]?(n[d]=u(p,r+"."+d),a(n,d,r+"."+d)):(null!=n[d]&&(n[d]instanceof Array||(n[d]=[n[d]],a(n,d,r+"."+d))),n[d][n[d].length]=u(p,r+"."+d)))}for(var f=0;f<t.attributes.length;f++){var m=t.attributes.item(f);n.__cnt++,n[e.attributePrefix+m.name]=m.value}var g=o(t);return null!=g&&""!=g&&(n.__cnt++,n.__prefix=g),null!=n["#text"]&&(n.__text=n["#text"],n.__text instanceof Array&&(n.__text=n.__text.join("\n")),e.escapeMode&&(n.__text=s(n.__text)),e.stripWhitespaces&&(n.__text=n.__text.trim()),delete n["#text"],"property"==e.arrayAccessForm&&delete n["#text_asArray"],n.__text=c(n.__text,d,r+"."+d)),null!=n["#cdata-section"]&&(n.__cdata=n["#cdata-section"],delete n["#cdata-section"],"property"==e.arrayAccessForm&&delete n["#cdata-section_asArray"]),1==n.__cnt&&null!=n.__text?n=n.__text:0==n.__cnt&&"text"==e.emptyNodeForm?n="":n.__cnt>1&&null!=n.__text&&e.skipEmptyTextNodesForObj&&(e.stripWhitespaces&&""==n.__text||""==n.__text.trim())&&delete n.__text,delete n.__cnt,!e.enableToStringFunc||null==n.__text&&null==n.__cdata||(n.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),n}return t.nodeType==T.TEXT_NODE||t.nodeType==T.CDATA_SECTION_NODE?t.nodeValue:void 0}function h(t,r,i,o){var s="<"+(null!=t&&null!=t.__prefix?t.__prefix+":":"")+r;if(null!=i)for(var a=0;a<i.length;a++){var l=i[a],c=t[l];e.escapeMode&&(c=n(c)),s+=" "+l.substr(e.attributePrefix.length)+"='"+c+"'"}return s+=o?"/>":">"}function p(e,t){return"</"+(null!=e.__prefix?e.__prefix+":":"")+t+">"}function d(e,t){return-1!==e.indexOf(t,e.length-t.length)}function f(t,r){return"property"==e.arrayAccessForm&&d(r.toString(),"_asArray")||0==r.toString().indexOf(e.attributePrefix)||0==r.toString().indexOf("__")||t[r]instanceof Function?!0:!1}function m(e){var t=0;if(e instanceof Object)for(var r in e)f(e,r)||t++;return t}function g(t){var r=[];if(t instanceof Object)for(var i in t)-1==i.toString().indexOf("__")&&0==i.toString().indexOf(e.attributePrefix)&&r.push(i);return r}function v(t){var r="";return null!=t.__cdata&&(r+="<![CDATA["+t.__cdata+"]]>"),null!=t.__text&&(r+=e.escapeMode?n(t.__text):t.__text),r}function b(t){var r="";return t instanceof Object?r+=v(t):null!=t&&(r+=e.escapeMode?n(t):t),r}function _(e,t,r){var i="";if(0==e.length)i+=h(e,t,r,!0);else for(var o=0;o<e.length;o++)i+=h(e[o],t,g(e[o]),!1),i+=y(e[o]),i+=p(e[o],t);return i}function y(e){var t="",r=m(e);if(r>0)for(var i in e)if(!f(e,i)){var o=e[i],n=g(o);if(null==o||void 0==o)t+=h(o,i,n,!0);else if(o instanceof Object)if(o instanceof Array)t+=_(o,i,n);else if(o instanceof Date)t+=h(o,i,n,!1),t+=o.toISOString(),t+=p(o,i);else{var s=m(o);s>0||null!=o.__text||null!=o.__cdata?(t+=h(o,i,n,!1),t+=y(o),t+=p(o,i)):t+=h(o,i,n,!0)}else t+=h(o,i,n,!1),t+=b(o),t+=p(o,i)}return t+=b(e)}var x="1.1.5";e=e||{},t(),r();var T={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(e){var t=window.ActiveXObject||"ActiveXObject"in window;if(void 0===e)return null;var r;if(window.DOMParser){var i=new window.DOMParser,o=null;if(!t)try{o=i.parseFromString("INVALID","text/xml").childNodes[0].namespaceURI}catch(n){o=null}try{r=i.parseFromString(e,"text/xml"),null!=o&&r.getElementsByTagNameNS(o,"parsererror").length>0&&(r=null)}catch(n){r=null}}else 0==e.indexOf("<?")&&(e=e.substr(e.indexOf("?>")+2)),r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(e);return r},this.asArray=function(e){return e instanceof Array?e:[e]},this.toXmlDateTime=function(e){return e instanceof Date?e.toISOString():"number"==typeof e?new Date(e).toISOString():null},this.asDateTime=function(e){return"string"==typeof e?l(e):e},this.xml2json=function(e){return u(e)},this.xml_str2json=function(e){var t=this.parseXmlString(e);return null!=t?this.xml2json(t):null},this.json2xml_str=function(e){return y(e)},this.json2xml=function(e){var t=this.json2xml_str(e);return this.parseXmlString(t)},this.getVersion=function(){return x}}function Rappid(){this.map=null,this.routeLayer=null,this.latlng=null,this.vehicles=null,this.shape=null,this.availableRoutes=ko.observableArray(),this.route=ko.observable(),this.stops=ko.observableArray(),this.includeList=ko.observable(!0),this.includeMap=ko.observable(!0),this.includeToggleBtn=ko.computed(function(){return!this.includeList()||!this.includeMap()}.bind(this))}function Shape(e,t){this.route=e,this.direction=t,this._shape=[]}function Stop(e){var t=e.stop_name.replace("(SB)","").replace("(NB)","");this.name=ko.observable(t),this.direction=ko.observable(parseInt(e.direction_id)),this.route=ko.observable(parseInt(e.route_id)),this.code=ko.observable(e.stop_code),this.desc=ko.observable(e.stop_desc),this.id=ko.observable(e.stop_id),this.lat=ko.observable(e.stop_lat),this.lon=ko.observable(e.stop_lon),this.timezone=ko.observable(e.stop_timezone),this.url=ko.observable(e.url),this.errorMsg=ko.observable(),this.trips=ko.observableArray(),this.closest=ko.observable(!1),this.cssId=ko.observable("stop-"+e.stop_id),this.showTrips=ko.observable(!1),this.loadedTrips=ko.observable(!1),this.loading=ko.observable(!1),this.showProgress=ko.computed(function(){return this.loading()&&!this.loadedTrips()}.bind(this)),this.color="rgb(199,16,22)",this.marker=leaflet.circleMarker([this.lat(),this.lon()],{color:"white",opacity:1,weight:3,fillColor:this.color,fill:!0,fillOpacity:1,radius:12,zIndexOffset:config.stopZIndex}),this.marker.bindPopup(this.popupContent()),this.marker.addEventListener("click",function(){this.loadedTrips()||this.loadTrips().then(null,console.error)}.bind(this))}function Trip(e){this.tripTime=ko.observable(e.Triptime),this.id=ko.observable(e.Tripid),this.skedTripID=ko.observable(e.Skedtripid),this.block=ko.observable(e.Block),this.exception=ko.observable(e.Exception),this.moment=ko.computed(function(){return moment(this.tripTime(),"hh:mm A")}.bind(this)),this.prettyTime=ko.computed(function(){return this.moment().fromNow()}.bind(this)),this.old=ko.computed(function(){return!this.moment().isAfter()}.bind(this))}function Vehicles(e,t){this.route=e,this.direction=t,this._vehicles=[],this._markers={}}var leaflet=require("leaflet"),when=require("when"),LocateControl=leaflet.Control.extend({userLatLng:[0,0],innerMarker:null,outerMarker:null,map:null,options:{icon:"icon-location",position:"topleft",zoomLevel:16,pollInterval:3e4},onAdd:function(e){this.container=leaflet.DomUtil.create("div","locate-control leaflet-bar leaflet-control"),this.map=e;var t=leaflet.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single "+this.options.icon,this.container);return leaflet.DomEvent.on(t,"click",leaflet.DomEvent.stopPropagation).on(t,"click",leaflet.DomEvent.preventDefault).on(t,"click",this.zoomToLocation.bind(this)).on(t,"dblclick",leaflet.DomEvent.stopPropagation),this.locate(),this.container},zoomToLocation:function(){this.map.setView(this.userLatLng,this.options.zoomLevel)},locate:function(){this.container.classList.add("loading"),this.map.locate({maximumAge:1e3,enableHighAccuracy:!0,watch:!0}),this.map.on("locationfound",function(e){this.userLatLng=e.latlng,this.updateMarkers(),this.container.classList.remove("loading")}.bind(this)),this.map.on("locationerror",function(e){this.userLatLng={lat:30.268066,lng:-97.743189},this.updateMarkers(),this.container.classList.remove("loading"),console.error("Unable to find location: ",e.message)}.bind(this))},updateMarkers:function(){this.innerMarker&&this.outerMarker||this.createMarkers(this.map),this.innerMarker.setLatLng(this.userLatLng),this.outerMarker.setLatLng(this.userLatLng)},createMarkers:function(){this.innerMarker=leaflet.circleMarker(this.userLatLng,{weight:0,fillColor:"rgb(16,94,251)",fill:!0,fillOpacity:1,radius:5}),this.outerMarker=leaflet.circleMarker(this.userLatLng,{color:"rgb(20,130,210)",opacity:1,weight:2,fillColor:"rgb(108,196,253)",fill:!0,fillOpacity:.4,radius:15}),this.outerMarker.addTo(this.map),this.outerMarker.bindPopup("Current Location"),this.innerMarker.addTo(this.map)}});module.exports=LocateControl,module.exports=X2JS;var config={vehicleZIndex:10,stopZIndex:5};module.exports=config;var $=require("jquery"),ko=require("knockout"),Rappid=require("./rappid"),rappid=window.rappid=new Rappid;window.ko=ko,$(document).ready(function(){ko.applyBindings(rappid,document.getElementById("lerappid")),rappid.start().catch(function(e){console.error(e),"The CapMetro API is unavailable"===e&&rappid.rustle()})});var ko=require("knockout"),L=require("leaflet"),when=require("when"),NProgress=require("NProgress"),LocateControl=require("./LocateControl"),RoutesCollection=require("./models/RoutesCollection"),Vehicles=require("./models/Vehicles"),Shape=require("./models/Shape"),StopCollection=require("./models/StopCollection");Rappid.prototype={start:function(){var e=when.defer();return this.resize(),this.setupMap(),RoutesCollection.fetch().then(function(t){this.availableRoutes(t);var r=JSON.parse(localStorage.getItem("rappid:route")),i=this.availableRoutes()[0];r&&(i=this.availableRoutes().filter(function(e){return r.id===e.id&&r.direction===e.direction})[0]),this.route(i),this.setupRoute().then(null,console.error),e.resolve()}.bind(this),e.reject),NProgress.configure({showSpinner:!1}),e.promise},refresh:function(){NProgress.start();var e,t=when.defer(),r=this.vehicles.fetch(),i=this.stops().map(function(e){return e.refresh()});return r.then(this.vehicles.draw.bind(this.vehicles,this.routeLayer)),e=[r],e=e.concat(i),when.all(e).done(function(){NProgress.done(),setTimeout(this.refresh.bind(this),15e3),t.resolve(!0)}.bind(this),function(e){console.error(e),NProgress.done(),"The CapMetro API is unavailable"===e&&this.rustle(),t.resolve(!1)}.bind(this)),t.promise},setupMap:function(){var e,t,r;this.map=L.map("map",{zoomControl:!1}),this.map.setView([30.267153,-97.743061],12),e=L.tileLayer("https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png",{maxZoom:18,attribution:'<a href="http://openstreetmap.org">OpenStreetMap</a> | <a href="http://mapbox.com">Mapbox</a>',id:"drmaples.ipbindf8"}),t=new L.Control.Zoom({position:"bottomright"}),r=new LocateControl({position:"bottomright",zoomLevel:16}),e.addTo(this.map),t.addTo(this.map),r.addTo(this.map),this.map.on("locationfound",function(e){this.latlng||StopCollection.closest(this.stops(),e.latlng),this.latlng=e.latlng}.bind(this))},selectRoute:function(){this.setupRoute().done(null,console.error)},setupRoute:function(){var e,t,r,i,o=when.defer(),n=this.route().id,s=this.route().direction;return this.track(),console.log("Setup route",this.route()),localStorage.setItem("rappid:route",ko.toJSON(this.route())),this.routeLayer&&this.map.removeLayer(this.routeLayer),this.routeLayer=L.layerGroup(),this.routeLayer.addTo(this.map),this.vehicles=new Vehicles(n,s),this.shape=new Shape(n,s),t=this.shape.fetch(),t.then(this.shape.draw.bind(this.shape,this.routeLayer)),r=this.vehicles.fetch(),r.then(this.vehicles.draw.bind(this.vehicles,this.routeLayer)),i=StopCollection.fetch(n,s),i.then(function(e){StopCollection.draw(e,this.routeLayer),this.stops(e),this.latlng&&StopCollection.closest(e,this.latlng)}.bind(this)),e=[t,r,i],when.all(e).done(function(){setTimeout(this.refresh.bind(this),15e3),o.resolve()}.bind(this),function(e){console.error(e),NProgress.done(),"The CapMetro API is unavailable"===e&&this.rustle(),o.resolve(!1)}.bind(this)),o.promise},resize:function(){window.screen.width<=1024?(this.includeMap(!0),this.includeList(!1)):(this.includeMap(!0),this.includeList(!0))},toggleMap:function(){this.includeList(!this.includeList()),this.includeMap(!this.includeMap()),this.map.invalidateSize(),this.map.closePopup(),document.body.scrollTop=document.documentElement.scrollTop=0},track:function(){var e=this.route().id+"-"+this.route().direction;window.ga("send",{dimension1:e,hitType:"screen",screenName:e})},rustle:function(){window.alert("CapMetro is experiencing some system issues."),setTimeout(function(){window.alert("There is no need to be upset."),setTimeout(function(){window.location.href="https://www.youtube.com/watch?v=ygr5AHufBN4"},5e3)},2e3)}},module.exports=Rappid;var utils={formatDirection:function(e,t){if(e=parseInt(e),0===t)return 801===e?"North":550===e?"South":"South";if(1===t){if(801===e)return"South";if(550===e)return"North"}return"S"===t?"South":"N"===t?"North":void 0},getDirectionID:function(e,t){if(e=parseInt(e),t=t.toLowerCase().replace("/",""),"north"===t||"n"===t){if(801===e)return 0;if(550===e)return 1}if("south"===t||"s"===t){if(801===e)return 1;if(550===e)return 0}return 0}};module.exports=utils;var $=require("jquery"),when=require("when"),RoutesCollection={fetch:function(){var e=when.defer();return $.ajax({url:"data/routes.json"}).done(function(t){var r=t.map(function(e){return e});e.resolve(r)}.bind(this)).fail(function(t,r,i){console.error(i),e.reject(i)}),e.promise}};module.exports=RoutesCollection;var $=require("jquery"),leaflet=require("leaflet"),when=require("when"),config=require("../config");Shape.prototype={fetch:function(){var e=when.defer();return $.ajax({url:"data/shapes_"+this.route+"_"+this.direction+".json"}).done(function(t){this._shape=t.map(function(e){return new L.LatLng(e.shape_pt_lat,e.shape_pt_lon)}),e.resolve()}.bind(this)).fail(function(t,r,i){console.error(i),e.reject(i)}),e.promise},draw:function(e){var t="rgb(199,16,22)",r=new L.Polyline(this._shape,{color:t,stroke:!0,weight:5,opacity:.9,smoothFactor:1});r.addTo(e),r.bringToBack()}},module.exports=Shape;var ko=require("knockout"),when=require("when"),leaflet=require("leaflet"),TripCollection=require("./TripCollection"),fs=require("fs"),config=require("../config"),stopPopupHTML=fs.readFileSync(__dirname+"/../templates/stop-popup.html","utf8");Stop.prototype={toggleTrips:function(){this.showTrips(!this.showTrips()),this.showTrips()?this.marker.openPopup():this.marker.closePopup(),this.loadedTrips()||this.loadTrips().then(null,function(e){console.error(e)})},loadTrips:function(){var e=when.defer();return this.showTrips(!0),this.loading(!0),TripCollection.fetch(this.route(),this.direction(),this.id()).then(function(t){this.loadedTrips(!0),this.loading(!1),this.trips(t),this.errorMsg(null),e.resolve()}.bind(this),function(t){this.loadedTrips(!0),this.loading(!1),this.errorMsg(t),e.reject(t)}.bind(this)),e.promise},refresh:function(){return this.showTrips()?this.loadTrips():void 0},popupContent:function(){var e=document.createElement("div");return e.innerHTML=stopPopupHTML,ko.applyBindings(this,e),e}},module.exports=Stop;var $=require("jquery"),L=require("leaflet"),when=require("when"),geolib=require("geolib"),config=require("../config"),Stop=require("./Stop"),StopCollection={fetch:function(e,t){var r=when.defer();return $.ajax({url:"data/stops_"+e+"_"+t+".json"}).done(function(e){var t=e.map(function(e){return new Stop(e)});r.resolve(t)}).fail(function(e,t,i){console.error(i),r.reject(i)}),r.promise},draw:function(e,t){e.forEach(function(e){e.marker.addTo(t)})},closest:function(e,t){if(e.length){var r,i,o=e.map(function(e){return{latitude:e.lat(),longitude:e.lon()}}),n={latitude:t.lat,longitude:t.lng};return r=geolib.findNearest(n,o,0,1),i=e[parseInt(r.key)],i.closest(!0),document.body.scrollTop=document.getElementById(i.cssId()).offsetTop,document.getElementById("list").scrollTop=document.getElementById(i.cssId()).offsetTop,i.toggleTrips(),i}}};module.exports=StopCollection;var ko=require("knockout"),moment=require("moment");module.exports=Trip;var $=require("jquery"),when=require("when"),X2JS=require("../X2JS"),utils=require("../utils"),Trip=require("./Trip"),x2js=new X2JS({}),TripCollection={fetch:function(e,t,r){var i=when.defer(),o="http://query.yahooapis.com/v1/public/yql",n="http://www.capmetro.org/planner/s_service.asp?output=xml&opt=2&tool=SI&route="+e+"&stopid="+r;return $.ajax({url:o,data:{q:'select * from xml where url="'+n+'"',format:"xml"}}).done(function(e){var r,o,n,s,a=x2js.xml2json(e),l=a.query.results.Envelope;if(!l)return console.log(a),void i.reject("The CapMetro API is unavailable");if(r=a.query.results.Envelope.Body.Fault)return console.error(r),void i.reject(new Error(r.faultstring));o=a.query.results.Envelope.Body.SchedulenearbyResponse.Atstop.Service,Array.isArray(o)&&(o=o.filter(function(e){return utils.getDirectionID(e.Route,e.Direction)===t})[0]),n=o.Tripinfo,Array.isArray(n)||(n=[n]),s=n.map(function(e){return new Trip(e)});for(var c=0;c<s.length;c++)if(!s[c].old()){c>0&&(s=s.slice(c-1));break}i.resolve(s)}.bind(this)).fail(function(e,t,r){console.error("Fetch arrivals",r),i.reject()}),i.promise}};module.exports=TripCollection;var $=require("jquery"),L=require("leaflet"),when=require("when"),_=require("underscore"),X2JS=require("../X2JS"),utils=require("../utils"),config=require("../config"),x2js=new X2JS({});Vehicles.prototype={fetch:function(){var e=when.defer();return $.ajax({url:"http://query.yahooapis.com/v1/public/yql",data:{q:'select * from xml where url="http://www.capmetro.org/planner/s_buslocation.asp?route=*"',format:"xml"}}).done(function(t){var r,i=x2js.xml2json(t),o=i.query.results.Envelope;return o?(r=o.Body.BuslocationResponse,r.Vehicles?(this._vehicles=r.Vehicles.Vehicle,Array.isArray(this._vehicles)||(this._vehicles=[this._vehicles]),this._vehicles.forEach(function(e){var t=e.Positions.Position,r=Array.isArray(t)?t[0]:t;e.lat=r.split(",")[0],e.lng=r.split(",")[1]}),void e.resolve()):void e.reject(new Error("Zero active vehicles"))):(console.log(i),void e.reject("The CapMetro API is unavailable"))}.bind(this)).fail(function(t,r,i){e.reject(i)}),e.promise},draw:function(e){var t=this.route,r=this.direction,i=_.filter(this._vehicles,function(e){var i=parseInt(e.Route),o=utils.getDirectionID(e.Route,e.Direction);return t===i&&r===o}),o=i.map(function(e){return e.Vehicleid}),n=_.filter(Object.keys(this._markers),function(e){return!_.find(o,function(t){return t===e})});console.log("Vehicles",i.length,"Deleted",n.length),n.forEach(function(t){e.removeLayer(this._markers[t]),delete this._markers[t]}.bind(this)),i.forEach(function(t){var r=this._markers[t.Vehicleid],i=this.popupContent(t),o="Y"===t.Inservice?"rgb(34,189,252)":"rgb(188,188,188)";if(r){var n=r.getLatLng(),s=[n.lat,n.lng],a=[parseFloat(t.lat),parseFloat(t.lng)],l=200,c=[a[0]-s[0],a[1]-s[1]];return r._popup.setContent(i),r.setStyle({fillColor:o}),void(_.isEqual(s,a)||("visible"===document.visibilityState?this.animateMarker(r,0,l,s,c):r.setLatLng(a)))}r=L.circleMarker([t.lat,t.lng],{color:"#fff",weight:3,radius:15,opacity:1,fillOpacity:"0.9",fillColor:o,zIndexOffset:config.vehicleZIndex}),r.bindPopup(i),r.addTo(e),this._markers[t.Vehicleid]=r}.bind(this))},popupContent:function(e){var t='<span class="id">Vehicle '+e.Vehicleid+"</span>",r=["Updated at "+e.Updatetime,"Moving "+utils.formatDirection(e.Route,e.Direction)+" at "+e.Speed+"mph","Reliable? "+e.Reliable,"Stopped? "+e.Stopped,"Off Route? "+e.Offroute,"In Service? "+e.Inservice].join("<br />");return'<div class="vehicle">'+t+r+"</div>"},easeInOutCubic:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e+t:r/2*((e-=2)*e*e+2)+t},animateMarker:function(e,t,r,i,o){var n=this.easeInOutCubic(t,i[0],o[0],r),s=this.easeInOutCubic(t,i[1],o[1],r);e.setLatLng([n,s]),r>t&&setTimeout(this.animateMarker.bind(this,e,t+1,r,i,o),10)}},module.exports=Vehicles;
//# sourceMappingURL=bundle.js.map